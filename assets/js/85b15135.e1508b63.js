"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[471],{8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var r=t(6540);const s={},o=r.createContext(s);function i(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:n},e.children)}},9340:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>c,frontMatter:()=>i,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"px-88/software-setup/power-management-hat","title":"Power Management HAT","description":"Flash the firmware for the Power Management HAT.","source":"@site/docs/px-88/software-setup/power-management-hat.md","sourceDirName":"px-88/software-setup","slug":"/px-88/software-setup/power-management-hat","permalink":"/docs/px-88/software-setup/power-management-hat","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Power Management HAT","sidebar_position":3,"description":"Flash the firmware for the Power Management HAT."},"sidebar":"docsSidebar","previous":{"title":"OS & Screen","permalink":"/docs/px-88/software-setup/os-screen"},"next":{"title":"Status LED","permalink":"/docs/px-88/software-setup/status-led"}}');var s=t(4848),o=t(8453);const i={title:"Power Management HAT",sidebar_position:3,description:"Flash the firmware for the Power Management HAT."},a="Power Management HAT Setup",l={},d=[{value:"Set Up RP2040 Development Tools",id:"set-up-rp2040-development-tools",level:2},{value:"Install Soft Shutdown Script",id:"install-soft-shutdown-script",level:2},{value:"Enable UART Listening",id:"enable-uart-listening",level:2},{value:"Compile and Flash the Button Firmware",id:"compile-and-flash-the-button-firmware",level:2},{value:"1. Get Demo Source Code",id:"1-get-demo-source-code",level:3},{value:"2. Edit Source Code to Enable Button Demo",id:"2-edit-source-code-to-enable-button-demo",level:3},{value:"3. Compile the Firmware",id:"3-compile-the-firmware",level:3},{value:"4. Flash the Firmware to the HAT",id:"4-flash-the-firmware-to-the-hat",level:3},{value:"5. Confirm the Firmware is Working",id:"5-confirm-the-firmware-is-working",level:3},{value:"Default Button Behavior",id:"default-button-behavior",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"power-management-hat-setup",children:"Power Management HAT Setup"})}),"\n",(0,s.jsxs)(n.p,{children:["This section details the necessary steps to configure the HAT for Button Control (Power ON/Soft Shutdown) using a ",(0,s.jsx)(n.code,{children:"systemd"})," service and the Waveshare provided example firmware."]}),"\n",(0,s.jsxs)(n.p,{children:["I had to make some changes to the official Waveshare guide to get it working; this is what worked for me. For complete documentation, see the ",(0,s.jsx)(n.a,{href:"https://www.waveshare.com/wiki/Power_Management_HAT_(B)",children:"Waveshare Power Management HAT (B) Wiki"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"set-up-rp2040-development-tools",children:"Set Up RP2040 Development Tools"}),"\n",(0,s.jsx)(n.p,{children:"This prepares the Raspberry Pi to compile and flash the firmware for the HAT's onboard RP2040 microcontroller."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Configure Pico Compile Environment:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd ~\nwget https://raw.githubusercontent.com/raspberrypi/pico-setup/master/pico_setup.sh\nchmod +x pico_setup.sh\n./pico_setup.sh\nsudo reboot\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Install and Compile OpenOCD:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd ~/pico\nsudo apt install automake autoconf build-essential texinfo libtool libftdi-dev libusb-1.0-0-dev\ngit clone https://github.com/raspberrypi/openocd.git --recursive --branch rp2040-v0.12.0 --depth=1\n\ncd openocd\n./bootstrap\n./configure --enable-ftdi --enable-sysfsgpio --enable-bcm2835gpio\nmake -j3\nsudo make install\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"install-soft-shutdown-script",children:"Install Soft Shutdown Script"}),"\n",(0,s.jsx)(n.p,{children:"This ensures the Raspberry Pi OS runs a script to listen for the shutdown signal from the HAT."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Download and Extract Files:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd ~\nwget https://files.waveshare.com/upload/4/44/Power-Management-HAT.zip\nunzip Power-Management-HAT.zip\n\n# Move the Python script\nsudo mkdir -p $HOME/bin/PowerManagementHAT\nsudo mv -f ~/Power-Management-HAT/StatusDetection.py $HOME/bin/PowerManagementHAT/\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Create the ",(0,s.jsx)(n.code,{children:"systemd"})," Service File:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo nano /etc/systemd/system/waveshare-shutdown.service\n"})}),"\n",(0,s.jsx)(n.p,{children:"Paste and save (Ctrl+X, Y, Enter) the following configuration:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"[Unit]\nDescription=Waveshare Power HAT Shutdown Monitor\nAfter=multi-user.target\n\n[Service]\nType=simple\nUser=root\nGroup=root\nExecStart=/usr/bin/python3 /home/pi/bin/PowerManagementHAT/StatusDetection.py\nRestart=always\nRestartSec=5\nStandardOutput=journal\nStandardError=journal\n\n[Install]\nWantedBy=multi-user.target\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Enable and Start the Service:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo systemctl daemon-reload\nsudo systemctl enable waveshare-shutdown.service\nsudo systemctl start waveshare-shutdown.service\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"enable-uart-listening",children:"Enable UART Listening"}),"\n",(0,s.jsx)(n.p,{children:"For the battery status to work, enable UART on the Raspberry Pi. This will allow the RP2040 to send battery status data to the Pi."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo raspi-config nonint do_serial 1\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can also find this in the ",(0,s.jsx)(n.code,{children:"raspi-config"})," interface under ",(0,s.jsx)(n.strong,{children:'"Interface Options" \u2192 "Serial Port"'}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"compile-and-flash-the-button-firmware",children:"Compile and Flash the Button Firmware"}),"\n",(0,s.jsx)(n.p,{children:"This final step flashes firmware that enables button control."}),"\n",(0,s.jsx)(n.admonition,{title:"Check Power Connection",type:"warning",children:(0,s.jsx)(n.p,{children:"Make sure you have power connected directly to the Pi and not the Power Management HAT before proceeding with the firmware flashing. The HAT will restart and we don't want the Pi to lose power during this process."})}),"\n",(0,s.jsx)(n.h3,{id:"1-get-demo-source-code",children:"1. Get Demo Source Code"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd ~\nwget https://files.waveshare.com/upload/2/27/Power-example.7z\n7z x ./Power-example.7z\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-edit-source-code-to-enable-button-demo",children:"2. Edit Source Code to Enable Button Demo"}),"\n",(0,s.jsxs)(n.p,{children:["Open the main C file (",(0,s.jsx)(n.code,{children:"~/Power-example/Power_Management_HAT.c"}),") and enable the ",(0,s.jsx)(n.code,{children:"Button_Ctr_"})," lines while commenting out the ",(0,s.jsx)(n.code,{children:"Period_Time_"})," lines."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"   int main()\n   {\n   /* Initialize function */\n   Button_Ctr_Init();\n   //Period_Time_Init();\n   //Cycle_Time_Init();\n\n   /*Calls loop functions*/\n   while (true)\n   {\n      Button_Ctr_Loop();\n      //Period_Time_Loop();\n      //Cycle_Time_Loop();\n   }\n\n   return 0;\n   }\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-compile-the-firmware",children:"3. Compile the Firmware"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd ~/Power-example/build/\nexport PICO_SDK_PATH=/home/pi/pico/pico-sdk\ncmake ..\nmake -j\n"})}),"\n",(0,s.jsx)(n.h3,{id:"4-flash-the-firmware-to-the-hat",children:"4. Flash the Firmware to the HAT"}),"\n",(0,s.jsxs)(n.p,{children:["Place the HAT in ",(0,s.jsx)(n.strong,{children:"BOOTSEL mode"}),", then run:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'openocd -f interface/raspberrypi-swd.cfg -f target/rp2040.cfg -c "program ./Power_Management_HAT.elf verify reset exit"\n'})}),"\n",(0,s.jsx)(n.h3,{id:"5-confirm-the-firmware-is-working",children:"5. Confirm the Firmware is Working"}),"\n",(0,s.jsx)(n.p,{children:"Unplug the USB cable from the Pi, reconnect it to the Power Management HAT. You can now use the onboard power button to turn the Pi on and off."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"default-button-behavior",children:"Default Button Behavior"}),"\n",(0,s.jsx)(n.p,{children:"Once the firmware is running, the onboard PWR button will function as follows:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Action"}),(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Duration"}),(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Result"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Power On"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Short Press (< 2 seconds)"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"The HAT powers the Raspberry Pi on."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Soft Shutdown"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Long Press (> 4 seconds but < 8 seconds)"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Pi executes a soft shutdown, and the HAT cuts power."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Hard Power Off"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Very Long Press (> 8 seconds)"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"HAT immediately cuts power to the Pi."})]})]})]}),"\n",(0,s.jsx)(n.hr,{})]})}function c(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);